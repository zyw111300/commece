# Django ç”µå­å•†åŠ¡ç³»ç»Ÿé¡¹ç›®è®¾è®¡æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®èƒŒæ™¯

æœ¬é¡¹ç›®æ˜¯åŸºäºDjango REST Frameworkå¼€å‘çš„ç”µå­å•†åŠ¡ç³»ç»Ÿï¼Œä¸“æ³¨äºè§£å†³é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ‰¹é‡è®¢å•å¤„ç†å’Œå•†å“æœç´¢é—®é¢˜ã€‚ç³»ç»Ÿé‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œåç«¯æä¾›RESTful
APIï¼Œå‰ç«¯ä½¿ç”¨Vue.js + Element UIæ„å»ºã€‚

### æ ¸å¿ƒåŠŸèƒ½

1. **æ‰¹é‡è®¢å•å¤„ç†** - æ”¯æŒä¸€æ¬¡æ€§ä¸‹å•å¤šä¸ªå•†å“ï¼Œå…·å¤‡å¹¶å‘æ§åˆ¶å’Œåº“å­˜ç®¡ç†
2. **å•†å“æœç´¢** - æä¾›é«˜æ€§èƒ½çš„å•†å“æœç´¢åŠŸèƒ½ï¼Œæ”¯æŒç¼“å­˜ä¼˜åŒ–
3. **åº“å­˜ç®¡ç†** - å®æ—¶åº“å­˜è·Ÿè¸ªï¼Œé˜²æ­¢è¶…å–
4. **ç”¨æˆ·ç•Œé¢** - ç°ä»£åŒ–çš„Webç•Œé¢ï¼Œæ”¯æŒç§»åŠ¨ç«¯

### æŠ€æœ¯é€‰å‹

- **åç«¯æ¡†æ¶**: Django 5.2 + Django REST Framework
- **æ•°æ®åº“**: MySQL 8.0+
- **ç¼“å­˜**: Redis
- **å‰ç«¯æ¡†æ¶**: Vue.js 3 + Element Plus
- **æ„å»ºå·¥å…·**: Vite
- **APIæ–‡æ¡£**: å†…ç½®RESTful API

### æ¨¡å—åˆ’åˆ†

### æ ¸å¿ƒæ•°æ®è¡¨ç»“æ„

#### 1. Product (å•†å“è¡¨)

```sql
CREATE TABLE products
(
    id             INT PRIMARY KEY AUTO_INCREMENT,
    name           VARCHAR(255)   NOT NULL COMMENT 'å•†å“åç§°',
    description    TEXT COMMENT 'å•†å“æè¿°',
    price          DECIMAL(10, 2) NOT NULL COMMENT 'ä»·æ ¼',
    stock_quantity INT UNSIGNED DEFAULT 0 COMMENT 'åº“å­˜æ•°é‡',
    keywords       VARCHAR(255) COMMENT 'æœç´¢å…³é”®è¯',
    status         VARCHAR(20) DEFAULT 'active' COMMENT 'çŠ¶æ€',
    version        INT UNSIGNED DEFAULT 1 COMMENT 'ç‰ˆæœ¬å·(ä¹è§‚é”)',
    created_at     TIMESTAMP   DEFAULT CURRENT_TIMESTAMP,
    updated_at     TIMESTAMP   DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX          idx_name (name),
    INDEX          idx_status (status),
    INDEX          idx_keywords (keywords)
) ENGINE=InnoDB;
```

#### 2. Order (è®¢å•è¡¨)

```sql
CREATE TABLE orders
(
    id           INT PRIMARY KEY AUTO_INCREMENT,
    order_no     VARCHAR(50) UNIQUE NOT NULL COMMENT 'è®¢å•å·',
    user_id      INT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID',
    total_amount DECIMAL(10, 2)     NOT NULL COMMENT 'æ€»é‡‘é¢',
    status       VARCHAR(20) DEFAULT 'pending' COMMENT 'è®¢å•çŠ¶æ€',
    created_at   TIMESTAMP   DEFAULT CURRENT_TIMESTAMP,
    updated_at   TIMESTAMP   DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX        idx_order_no (order_no),
    INDEX        idx_user_id (user_id),
    INDEX        idx_status (status)
) ENGINE=InnoDB;
```

#### 3. OrderItem (è®¢å•æ˜ç»†è¡¨)

```sql
CREATE TABLE order_items
(
    id            INT PRIMARY KEY AUTO_INCREMENT,
    order_id      INT            NOT NULL,
    product_id    INT            NOT NULL,
    quantity      INT UNSIGNED NOT NULL COMMENT 'æ•°é‡',
    unit_price    DECIMAL(10, 2) NOT NULL COMMENT 'å•ä»·',
    total_price   DECIMAL(10, 2) NOT NULL COMMENT 'å°è®¡',
    status        VARCHAR(20) DEFAULT 'pending' COMMENT 'çŠ¶æ€',
    error_message TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',
    created_at    TIMESTAMP   DEFAULT CURRENT_TIMESTAMP,

    INDEX         idx_order (order_id),
    INDEX         idx_product (product_id),
    FOREIGN KEY (order_id) REFERENCES orders (id),
    FOREIGN KEY (product_id) REFERENCES products (id)
) ENGINE=InnoDB;
```

#### 4. StockLog (åº“å­˜æ—¥å¿—è¡¨)

```sql
CREATE TABLE stock_logs
(
    id              INT PRIMARY KEY AUTO_INCREMENT,
    product_id      INT         NOT NULL,
    order_id        INT,
    change_type     VARCHAR(20) NOT NULL COMMENT 'å˜æ›´ç±»å‹',
    quantity_before INT UNSIGNED NOT NULL COMMENT 'å˜æ›´å‰åº“å­˜',
    quantity_after  INT UNSIGNED NOT NULL COMMENT 'å˜æ›´ååº“å­˜',
    change_quantity INT         NOT NULL COMMENT 'å˜æ›´æ•°é‡',
    reason          VARCHAR(255) COMMENT 'åŸå› ',
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX           idx_product (product_id),
    INDEX           idx_order (order_id),
    INDEX           idx_created_at (created_at),
    FOREIGN KEY (product_id) REFERENCES products (id),
    FOREIGN KEY (order_id) REFERENCES orders (id)
) ENGINE=InnoDB;
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

### 1. æ‰¹é‡è®¢å•å¤„ç†

#### ä¸šåŠ¡æµç¨‹

```
ç”¨æˆ·æäº¤æ‰¹é‡è®¢å•
        â†“
å‚æ•°éªŒè¯ (ç”¨æˆ·IDã€å•†å“åˆ—è¡¨)
        â†“
ç”Ÿæˆè®¢å•å· (æ—¶é—´æˆ³+éšæœºæ•°)
        â†“
å¼€å¯æ•°æ®åº“äº‹åŠ¡
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éå†æ¯ä¸ªè®¢å•é¡¹                   â”‚
â”‚                                â”‚
â”‚ 1. è·å–å•†å“ä¿¡æ¯(æ‚²è§‚é”)          â”‚
â”‚ 2. æ£€æŸ¥å•†å“çŠ¶æ€                  â”‚
â”‚ 3. æ£€æŸ¥åº“å­˜æ•°é‡                  â”‚
â”‚ 4. æ‰£å‡åº“å­˜                     â”‚
â”‚ 5. è®°å½•åº“å­˜æ—¥å¿—                  â”‚
â”‚ 6. åˆ›å»ºè®¢å•æ˜ç»†                  â”‚
â”‚                                â”‚
â”‚ å¤±è´¥å¤„ç†:                       â”‚
â”‚ - è®°å½•é”™è¯¯ä¿¡æ¯                   â”‚
â”‚ - ä¸å½±å“å…¶ä»–å•†å“                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
æ›´æ–°è®¢å•æ€»çŠ¶æ€
        â†“
æäº¤äº‹åŠ¡
        â†“
æ¸…é™¤ç›¸å…³ç¼“å­˜
        â†“
è¿”å›å¤„ç†ç»“æœ
```

#### æ ¸å¿ƒä»£ç ç»“æ„

```python
class OrderService:
    def create_batch_order(self, user_id: int, order_items: List[Dict]) -> Dict:
        """æ‰¹é‡åˆ›å»ºè®¢å•"""
        # 1. å‚æ•°éªŒè¯
        self._validate_order_params(user_id, order_items)

        # 2. ç”Ÿæˆè®¢å•å·
        order_no = self.order_generator.generate()

        # 3. å¤„ç†æ‰¹é‡è®¢å•
        return self._process_batch_order(user_id, order_no, order_items)

    def _process_batch_order(self, user_id: int, order_no: str, items: List) -> Dict:
        """å¤„ç†æ‰¹é‡è®¢å•é€»è¾‘"""
        with transaction.atomic():
            # åˆ›å»ºä¸»è®¢å•
            order = self._create_main_order(user_id, order_no)

            # å¤„ç†æ¯ä¸ªè®¢å•é¡¹
            results = self._process_order_items(order, items)

            # æ›´æ–°è®¢å•çŠ¶æ€
            self._update_order_status(order, results)

            return results
```

#### å¹¶å‘æ§åˆ¶ç­–ç•¥

##### æ‚²è§‚é”å®ç°

```python
def get_product_with_lock(self, product_id: int) -> Product:
    """è·å–å•†å“å¹¶åŠ é”"""
    return Product.objects.select_for_update().get(id=product_id)
```

##### ä¹è§‚é”å®ç° (æ¨èæ‰©å±•)

```python
def update_stock_with_version(self, product_id: int, quantity: int) -> bool:
    """ä½¿ç”¨ç‰ˆæœ¬å·æ›´æ–°åº“å­˜"""
    updated = Product.objects.filter(
        id=product_id,
        version=F('version')
    ).update(
        stock_quantity=F('stock_quantity') - quantity,
        version=F('version') + 1
    )
    return updated > 0
```

### 2. å•†å“æœç´¢åŠŸèƒ½

#### æœç´¢æ¶æ„

```
ç”¨æˆ·æœç´¢è¯·æ±‚
        â†“
å‚æ•°éªŒè¯ (å…³é”®è¯ã€åˆ†é¡µ)
        â†“
ç¼“å­˜æ£€æŸ¥
        â†“
    æ˜¯å¦å‘½ä¸­ç¼“å­˜ï¼Ÿ
       â†™       â†˜
    å‘½ä¸­           æœªå‘½ä¸­
     â†“               â†“
  è¿”å›ç¼“å­˜ç»“æœ      æ•°æ®åº“æŸ¥è¯¢
                     â†“
                 æ„å»ºæœç´¢æ¡ä»¶
                     â†“
                 æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢
                     â†“
                 å¤„ç†æŸ¥è¯¢ç»“æœ
                     â†“
                 å†™å…¥ç¼“å­˜
                     â†“
                 è¿”å›æœç´¢ç»“æœ
```

#### ç¼“å­˜ç­–ç•¥è®¾è®¡

##### ç¼“å­˜Keyè®¾è®¡

```python
# æœç´¢ç»“æœç¼“å­˜
SEARCH_CACHE_KEY = "search:{keyword}:{page}:{size}"
# å•†å“è¯¦æƒ…ç¼“å­˜
PRODUCT_CACHE_KEY = "product:{product_id}"
# å•†å“åˆ—è¡¨ç¼“å­˜
PRODUCT_LIST_CACHE_KEY = "products:list:{page}:{size}:{filters_hash}"
```

##### ç¼“å­˜å¤±æ•ˆç­–ç•¥

```python
class CacheManager:
    def invalidate_product_cache(self, product_id: int):
        """å•†å“ç¼“å­˜å¤±æ•ˆ"""
        # åˆ é™¤å•†å“è¯¦æƒ…ç¼“å­˜
        cache.delete(f"product:{product_id}")

        # åˆ é™¤ç›¸å…³æœç´¢ç¼“å­˜
        cache.delete_pattern("search:*")

        # åˆ é™¤å•†å“åˆ—è¡¨ç¼“å­˜
        cache.delete_pattern("products:list:*")
```

#### æœç´¢ç®—æ³•å®ç°

```python
def search_products(self, keyword: str, page: int, size: int) -> Dict:
    """å•†å“æœç´¢"""
    # 1. æ„å»ºæŸ¥è¯¢æ¡ä»¶
    query = Q(name__icontains=keyword) | Q(keywords__icontains=keyword)
    query &= Q(status='active')

    # 2. æ‰§è¡ŒæŸ¥è¯¢
    products = Product.objects.filter(query).order_by('-created_at')

    # 3. åˆ†é¡µå¤„ç†
    paginator = Paginator(products, size)
    page_obj = paginator.get_page(page)

    # 4. è¿”å›ç»“æœ
    return {
        'products': page_obj.object_list,
        'total': paginator.count,
        'page': page,
        'size': size,
        'total_pages': paginator.num_pages,
        'has_next': page_obj.has_next(),
        'has_previous': page_obj.has_previous(),
    }
```

## ğŸ¯ APIè®¾è®¡è§„èŒƒ

### RESTful API è®¾è®¡

#### å•†å“ç›¸å…³API

```
GET    /api/products/              # è·å–å•†å“åˆ—è¡¨
GET    /api/products/{id}/         # è·å–å•†å“è¯¦æƒ…
GET    /api/products/search/       # æœç´¢å•†å“
GET    /api/products/{id}/stock-logs/  # è·å–åº“å­˜æ—¥å¿—
POST   /api/products/              # åˆ›å»ºå•†å“(ç®¡ç†å‘˜)
PUT    /api/products/{id}/         # æ›´æ–°å•†å“(ç®¡ç†å‘˜)
DELETE /api/products/{id}/         # åˆ é™¤å•†å“(ç®¡ç†å‘˜)
```

#### è®¢å•ç›¸å…³API

```
GET    /api/orders/                # è·å–è®¢å•åˆ—è¡¨
GET    /api/orders/{order_no}/     # è·å–è®¢å•è¯¦æƒ…
POST   /api/orders/batch-create/   # æ‰¹é‡åˆ›å»ºè®¢å•
PUT    /api/orders/{order_no}/     # æ›´æ–°è®¢å•çŠ¶æ€
```

### è¯·æ±‚/å“åº”æ ¼å¼

#### æ‰¹é‡ä¸‹å•è¯·æ±‚

```json
{
  "user_id": 1001,
  "order_items": [
    {
      "product_id": 1,
      "quantity": 2
    },
    {
      "product_id": 2,
      "quantity": 1
    }
  ]
}
```

#### æ‰¹é‡ä¸‹å•å“åº”

```json
{
  "code": 200,
  "message": "è®¢å•å¤„ç†å®Œæˆ",
  "data": {
    "order_no": "ORD202412271234567890ABCD",
    "total_amount": "299.98",
    "status": "partial",
    "success_count": 1,
    "failed_count": 1,
    "items": [
      {
        "product_id": 1,
        "product_name": "iPhone 15",
        "quantity": 2,
        "unit_price": "99.99",
        "total_price": "199.98",
        "status": "success"
      },
      {
        "product_id": 2,
        "product_name": "AirPods Pro",
        "quantity": 1,
        "status": "failed",
        "error_message": "åº“å­˜ä¸è¶³ï¼Œå¯ç”¨åº“å­˜: 0ï¼Œéœ€è¦åº“å­˜: 1"
      }
    ]
  }
}
```

#### å•†å“æœç´¢å“åº”

```json
{
  "code": 200,
  "message": "æœç´¢æˆåŠŸ",
  "data": {
    "results": [
      {
        "id": 1,
        "name": "iPhone 15",
        "price": "99.99",
        "stock_quantity": 100,
        "status": "active"
      }
    ],
    "count": 1,
    "next": null,
    "previous": null
  }
}
```

## ğŸ”’ å®‰å…¨ä¸æ€§èƒ½

### å®‰å…¨è®¾è®¡

#### 1. è¾“å…¥éªŒè¯

```python
class BatchOrderSerializer(serializers.Serializer):
    user_id = serializers.IntegerField(min_value=1)
    order_items = serializers.ListField(
        child=OrderItemSerializer(),
        min_length=1,
        max_length=50  # é™åˆ¶æœ€å¤§è®¢å•é¡¹æ•°é‡
    )
```

### æ€§èƒ½ä¼˜åŒ–

#### 1. æ•°æ®åº“ä¼˜åŒ–

```sql
-- æ ¸å¿ƒç´¢å¼•
CREATE INDEX idx_products_search ON products (name, keywords, status);
CREATE INDEX idx_orders_user_status ON orders (user_id, status, created_at);
CREATE INDEX idx_stock_logs_product_time ON stock_logs (product_id, created_at);
```

## ğŸš€ éƒ¨ç½²æ–¹æ¡ˆ

### å¼€å‘ç¯å¢ƒ

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
python manage.py runserver

# å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨
cd frontend
npm run dev
```
